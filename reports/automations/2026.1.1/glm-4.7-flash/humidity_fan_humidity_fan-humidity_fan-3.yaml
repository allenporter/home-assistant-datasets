---
uuid: 458bd020-491e-47c2-bd5b-eb6e88b78d0a
task_id: humidity_fan_humidity_fan-humidity_fan-3
model_id: glm-4.7-flash
category: fan
task:
  input_text: |
    # Humidity Fan

    ## Problem statement

    Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

    ## Example use cases

    These are example use cases that could be used with the blueprint:

    - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
    - Make sure the garage does not get too humid

    ## Detailed Description

    The blueprint should accept two inputs:

    | Input               | Description                                                           |
    | ------------------- | --------------------------------------------------------------------- |
    | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
    | `humidity_level` | A `number` selector to set the value used as the trigger. |
    | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

    The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
    triggered, the fan should be turned off. The fan should also be stopped when the
    sensor goes back down below the desired level. The automation should not try to
    turn the fan on if it is already on, and should not turn the fan off when it is
    already off.
response: |-
  ```yaml
  blueprint:
    name: Humidity Fan
    description: Turns on a fan when humidity is high and off when low.
    domain: automation
    input:
      humidity_sensor:
        name: Humidity Sensor
        selector:
          entity:
            domain: sensor
      humidity_level:
        name: Humidity Level
        selector:
          number:
            min: 0
            max: 100
            unit_of_measurement: '%'
      fan_entity:
        name: Fan Entity
        selector:
          entity:
            domain: fan

  trigger:
    - platform: numeric_state
      entity_id: !input humidity_sensor
      above: !input humidity_level
    - platform: numeric_state
      entity_id: !input humidity_sensor
      below: !input humidity_level

  condition: []

  action:
    - service: fan.turn_on
      target:
        entity_id: !input fan_entity
    - service: fan.turn_off
      target:
        entity_id: !input fan_entity
  ```
context:
  conversation_trace:
  - event_type: async_process
    data:
      text: |
        # Humidity Fan

        ## Problem statement

        Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

        ## Example use cases

        These are example use cases that could be used with the blueprint:

        - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
        - Make sure the garage does not get too humid

        ## Detailed Description

        The blueprint should accept two inputs:

        | Input               | Description                                                           |
        | ------------------- | --------------------------------------------------------------------- |
        | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
        | `humidity_level` | A `number` selector to set the value used as the trigger. |
        | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

        The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
        triggered, the fan should be turned off. The fan should also be stopped when the
        sensor goes back down below the desired level. The automation should not try to
        turn the fan on if it is already on, and should not turn the fan off when it is
        already off.
      context:
        id: 01KG085FVF4DTW1PC4J35B40X7
        parent_id: null
        user_id: null
      conversation_id: null
      device_id: null
      satellite_id: null
      language: en
      agent_id: conversation.mock_title
      extra_system_prompt: null
    timestamp: 2026-01-27 17:31:34.640045+00:00
  - event_type: agent_detail
    data:
      messages:
      - role: system
        content: |-
          You are a voice assistant for Home Assistant.
          Answer questions about the world truthfully.
          Answer in plain text. Keep it simple and to the point.
          Current time is 09:31:34. Today's date is 2026-01-27.
        created: 2026-01-27 17:31:34.641248+00:00
      - role: user
        content: |
          # Humidity Fan

          ## Problem statement

          Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

          ## Example use cases

          These are example use cases that could be used with the blueprint:

          - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
          - Make sure the garage does not get too humid

          ## Detailed Description

          The blueprint should accept two inputs:

          | Input               | Description                                                           |
          | ------------------- | --------------------------------------------------------------------- |
          | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
          | `humidity_level` | A `number` selector to set the value used as the trigger. |
          | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

          The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
          triggered, the fan should be turned off. The fan should also be stopped when the
          sensor goes back down below the desired level. The automation should not try to
          turn the fan on if it is already on, and should not turn the fan off when it is
          already off.
        attachments: null
        created: 2026-01-27 17:31:34.640095+00:00
      - role: assistant
        agent_id: conversation.mock_title
        content: |-
          ```yaml
          blueprint:
            name: Humidity Fan
            description: Turns on a fan when humidity is high and off when low.
            domain: automation
            input:
              humidity_sensor:
                name: Humidity Sensor
                selector:
                  entity:
                    domain: sensor
              humidity_level:
                name: Humidity Level
                selector:
                  number:
                    min: 0
                    max: 100
                    unit_of_measurement: '%'
              fan_entity:
                name: Fan Entity
                selector:
                  entity:
                    domain: fan

          trigger:
            - platform: numeric_state
              entity_id: !input humidity_sensor
              above: !input humidity_level
            - platform: numeric_state
              entity_id: !input humidity_sensor
              below: !input humidity_level

          condition: []

          action:
            - service: fan.turn_on
              target:
                entity_id: !input fan_entity
            - service: fan.turn_off
              target:
                entity_id: !input fan_entity
          ```
        thinking_content: |-
          The user wants a Home Assistant blueprint automation based on the specific requirements provided.

          **Requirements Analysis:**
          1.  **Name:** Humidity Fan.
          2.  **Inputs:**
              *   `humidity_sensor` (Type: `sensor`): The entity representing the humidity level.
              *   `humidity_level` (Type: `number`): The threshold to trigger the automation (e.g., 60).
              *   `fan_entity` (Type: `fan`): The entity to control.
          3.  **Logic:**
              *   **Trigger:** When `humidity_sensor` state is *above* `humidity_level`.
              *   **Action (On):** Turn on `fan_entity` *only if it is off*.
              *   **Action (Off):** Turn off `fan_entity` *only if it is on*.
              *   **Secondary Trigger:** When `humidity_sensor` state drops *below* `humidity_level`.
              *   **Secondary Action:** Turn off `fan_entity` *only if it is on*.
          4.  **Constraint:** Don't try to turn the fan on if it is already on, and don't turn the fan off if it is already off.
          5.  **Blueprint Structure:** Needs `blueprint`, `input_boolean` (optional, but often good for enabling/disabling, though not strictly requested, I'll stick to the requested inputs first. The prompt asks for specific inputs: `humidity_sensor`, `humidity_level`, `fan_entity`). It needs `trigger`, `condition`, `action`.

          **Blueprint Drafting:**

          *   **Header:** Name, description.
          *   **Variables:** `humidity_sensor`, `humidity_level`, `fan_entity`.
          *   **Triggers:**
              *   Trigger 1: State of `humidity_sensor` goes above `humidity_level`.
              *   Trigger 2: State of `humidity_sensor` goes below `humidity_level`.
          *   **Conditions:**
              *   The prompt says "The automation should not try to turn the fan on if it is already on, and should not turn the fan off when it is already off."
              *   This logic can be handled in the `actions` section using `service:...` with `data: { entity_id: ... }` without specific turn-on/off commands, or by checking the state before action.
              *   However, the specific requirement "turn off when it is already off" implies a conditional action based on current state.
              *   *Option A:* Use `service: fan.turn_on` and `service: fan.turn_off`. Home Assistant handles the "already on/off" gracefully by doing nothing if it's already in that state. *Wait*, checking the HA docs (mental check), if I issue `fan.turn_off` and the fan is already off, it usually stays off. It doesn't throw an error. It doesn't turn it on. So standard services work fine for the "don't turn off if already off" part.
              *   *Refinement on "Don't turn on if already on":* Same logic. If I issue `fan.turn_on` and it's on, it stays on. So I don't strictly need a complex condition check *before* the action unless I want to prevent a notification or log entry, but for a silent automation, standard services are usually sufficient.
              *   *However*, the prompt specifically asks to "Make sure the garage does not get too humid" and detailed the "turn off when it is already off" constraint.
              *   Let's verify if the user wants logic like `if state: then action`. If I write:
                  *   Action: `service: fan.turn_on`, `target: { entity_id: fan_entity }`.
                  *   Action: `service: fan.turn_off`, `target: { entity_id: fan_entity }`.
                  *   If I run the automation, and the fan is on, and I send a turn_on command, it does nothing. If I send a turn_off command, it turns off.
              *   This satisfies the requirement perfectly.

          **Blueprint Code Construction:**

          ```yaml
          blueprint:
            name: Humidity Fan
            description: Turns a fan on when humidity is high and off when low.
            domain: automation
            input:
              humidity_sensor:
                name: Humidity Sensor
                selector:
                  entity:
                    domain: sensor
              humidity_level:
                name: Humidity Level
                selector:
                  number:
                    min: 0
                    max: 100
                    unit_of_measurement: '%'
              fan_entity:
                name: Fan Entity
                selector:
                  entity:
                    domain: fan

          trigger:
            - platform: numeric_state
              entity_id: !input humidity_sensor
              above: !input humidity_level
            - platform: numeric_state
              entity_id: !input humidity_sensor
              below: !input humidity_level

          condition: []

          action:
            - service: fan.turn_on
              target:
                entity_id: !input fan_entity
            - service: fan.turn_off
              target:
                entity_id: !input fan_entity
          ```

          **Review against constraints:**
          *   *Trigger above level:* Yes (`above: !input humidity_level`).
          *   *Turn on fan:* Yes (`fan.turn_on`).
          *   *Trigger below level:* Yes (`below: !input humidity_level`).
          *   *Turn off fan:* Yes (`fan.turn_off`).
          *   *Don't turn on if already on:* If the fan is on, `turn_on` does nothing.
          *   *Don't turn off if already off:* If the fan is off, `turn_off` does nothing.

          Is there any edge case? What if the fan entity is a `fan_only` or `fan`? The prompt says `fan` entity.

          Let's make sure the output is just the blueprint code in a code block, as requested by the persona "Answer in plain text. Keep it simple and to the point." usually implies providing the solution directly.

          Wait, the user prompt ends with a description, but doesn't explicitly ask for the code *in* a specific format, just "Create a blueprint automation". I will provide the YAML code.

          I will double-check the "turn off when it is already off" logic. Sometimes people write logic like `if state == 'on': service: turn_off`. But the simpler way is just to send the command. However, sometimes `fan.turn_on` implies checking the current state, but usually, in YAML automation, if I trigger, I just want the fan to respond to the humidity.
          Actually, looking at the prompt: "The automation should not try to turn the fan on if it is already on".
          If I send `fan.turn_on` and it is on, Home Assistant usually just acknowledges the command and does nothing.
          If I want to be extremely strict (like preventing the automation from firing at all if the fan is already on), that's over-engineering. The prompt implies the *result* should not change (fan stays on), which standard services do.

          Let's refine the Action block. Since `fan.turn_on` and `fan.turn_off` are mutually exclusive events in the context of "don't turn on if already on" and "don't turn off if already off", simply calling both services one after the other is the standard way to handle bidirectional control (high humidity -> on, low humidity -> off).

          One subtle detail: If humidity is exactly 60.0.
          Trigger 1: above 60.0 (False).
          Trigger 2: below 60.0 (False).
          So it won't flip-flop at exactly 60. This is correct.

          Final check of the YAML structure.

          ```yaml
          blueprint:
            name: Humidity Fan
            description: Turn on a fan based on humidity levels.
            domain: automation
            input:
              humidity_sensor:
                name: Humidity Sensor
                selector:
                  entity:
                    domain: sensor
              humidity_level:
                name: Humidity Threshold
                selector:
                  number:
                    min: 0
                    max: 100
                    unit_of_measurement: '%'
              fan_entity:
                name: Fan Entity
                selector:
                  entity:
                    domain: fan

          trigger:
            - platform: numeric_state
              entity_id: !input humidity_sensor
              above: !input humidity_level
            - platform: numeric_state
              entity_id: !input humidity_sensor
              below: !input humidity_level

          condition: []

          action:
            - service: fan.turn_on
              target:
                entity_id: !input fan_entity
            - service: fan.turn_off
              target:
                entity_id: !input fan_entity
          ```

          The prompt asks for "turn on the fan... turn off when sensor goes back down". The action block contains both.

          The persona guidelines say "Answer in plain text. Keep it simple and to the point." I will present the solution clearly.

          One small improvement: The prompt mentions "The automation should not try to turn the fan on if it is already on". While `fan.turn_on` is idempotent, some users might prefer an `if` condition or just the service call. Standard Home Assistant behavior is that calling the service if the state is already the target state does nothing. I will stick to the standard action sequence.

          Wait, strictly speaking, if I want to be robust, I can put conditions. But usually, for these prompts, the simple solution is preferred unless specified otherwise. The specific constraint "not try to turn the fan on if it is already on" sounds like a constraint on the behavior, not necessarily requiring a specific `condition:` block in the automation flow (which would require state checks or binary sensors). The simplest implementation that satisfies the requirement is using the standard services, as they are safe.

          Let's verify the `target` syntax. `service: fan.turn_on`, `target: { entity_id: !input fan_entity }` is the modern standard. Older versions used `data: { entity_id: ... }`. I will use the modern `target` syntax as it is the current standard.

          Final check of inputs.
          `humidity_sensor`: sensor.
          `humidity_level`: number.
          `fan_entity`: fan.

          Everything looks correct.

          Output format:
          ```yaml
          <code>
          ```

          The user didn't ask for the YAML *file content* specifically, but "Create a blueprint automation". Providing the YAML is the only way to do that in this context.

          One specific constraint: "The fan should also be stopped when the sensor goes back down below the desired level."
          My trigger includes `below`. My action includes `turn_off`.
          Logic holds.

          Is there any need for a delay? No, not mentioned.
          Is there any need for `max_exceeded: ignore`? Not mentioned.

          I will generate the YAML.

          One nuance: "The automation should not try to turn the fan on if it is already on".
          If I have two triggers (above and below), and I send both commands sequentially, `fan.turn_on` might happen if the fan was off due to the "below" trigger, and then `fan.turn_off` happens if the fan is on due to the "above" trigger.
          Example:
          Sensor: 59.9 -> 60.1 (Above).
          Fan: Off -> On.
          Sensor: 60.1 -> 59.9 (Below).
          Fan: On -> Off.
          This is correct.

          If the fan is stuck "on" (e.g., manual override without automation), the automation will try to turn it on (doing nothing) and then off (doing nothing or turning it off). Correct.

          I am confident in this solution.

          Wait, I should check if the `humidity_level` input needs a specific unit. It's a number selector. I'll set min/max to 0-100 for safety, as humidity is usually percent.

          Final Code Structure:
          ```yaml
          blueprint:
            name: Humidity Fan
            description: Turn on a fan based on humidity levels.
            domain: automation
            input:
              humidity_sensor:
                name: Humidity Sensor
                selector:
                  entity:
                    domain: sensor
              humidity_level:
                name: Humidity Level
                selector:
                  number:
                    min: 0
                    max: 100
                    unit_of_measurement: '%'
              fan_entity:
                name: Fan Entity
                selector:
                  entity:
                    domain: fan

          trigger:
            - platform: numeric_state
              entity_id: !input humidity_sensor
              above: !input humidity_level
            - platform: numeric_state
              entity_id: !input humidity_sensor
              below: !input humidity_level

          condition: []

          action:
            - service: fan.turn_on
              target:
                entity_id: !input fan_entity
            - service: fan.turn_off
              target:
                entity_id: !input fan_entity
          ```
          This looks solid.
        tool_calls: null
        native: null
        created: 2026-01-27 17:32:03.971861+00:00
      tools: null
    timestamp: 2026-01-27 17:31:34.641258+00:00
  duration_ms: 29331.958
  tries: 1
