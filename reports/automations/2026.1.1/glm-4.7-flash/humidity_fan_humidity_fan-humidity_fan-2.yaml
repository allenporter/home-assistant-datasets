---
uuid: 8ca23518-dafb-4dc6-a33d-d759bbba852b
task_id: humidity_fan_humidity_fan-humidity_fan-2
model_id: glm-4.7-flash
category: fan
task:
  input_text: |
    # Humidity Fan

    ## Problem statement

    Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

    ## Example use cases

    These are example use cases that could be used with the blueprint:

    - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
    - Make sure the garage does not get too humid

    ## Detailed Description

    The blueprint should accept two inputs:

    | Input               | Description                                                           |
    | ------------------- | --------------------------------------------------------------------- |
    | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
    | `humidity_level` | A `number` selector to set the value used as the trigger. |
    | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

    The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
    triggered, the fan should be turned off. The fan should also be stopped when the
    sensor goes back down below the desired level. The automation should not try to
    turn the fan on if it is already on, and should not turn the fan off when it is
    already off.
response: |-
  ```yaml
  blueprints:
    automation:
      name: Humidity Fan
      variables:
        humidity_sensor: !input 'humidity_sensor'
        humidity_level: !input 'humidity_level'
        fan_entity: !input 'fan_entity'
      trigger:
        - platform: numeric_state
          entity_id: !input 'humidity_sensor'
          above: !input 'humidity_level'
          id: 'humidity_high'
        - platform: numeric_state
          entity_id: !input 'humidity_sensor'
          below: !input 'humidity_level'
          id: 'humidity_low'
      condition:
        - condition: template
          value_template: >
            {% if trigger.id == 'humidity_high' and is_state(fan_entity, 'off') or
               trigger.id == 'humidity_low' and is_state(fan_entity, 'on') %}
              true
            {% else %}
              false
            {% endif %}
      action:
        - service: >
            {% if trigger.id == 'humidity_high' %} fan.turn_on
            {% else %} fan.turn_off
            {% endif %}
          target:
            entity_id: !input 'fan_entity'
      mode: single
  ```
context:
  conversation_trace:
  - event_type: async_process
    data:
      text: |
        # Humidity Fan

        ## Problem statement

        Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

        ## Example use cases

        These are example use cases that could be used with the blueprint:

        - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
        - Make sure the garage does not get too humid

        ## Detailed Description

        The blueprint should accept two inputs:

        | Input               | Description                                                           |
        | ------------------- | --------------------------------------------------------------------- |
        | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
        | `humidity_level` | A `number` selector to set the value used as the trigger. |
        | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

        The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
        triggered, the fan should be turned off. The fan should also be stopped when the
        sensor goes back down below the desired level. The automation should not try to
        turn the fan on if it is already on, and should not turn the fan off when it is
        already off.
      context:
        id: 01KG084VYNVNN8MF6MR0W95FP2
        parent_id: null
        user_id: null
      conversation_id: null
      device_id: null
      satellite_id: null
      language: en
      agent_id: conversation.mock_title
      extra_system_prompt: null
    timestamp: 2026-01-27 17:31:14.261286+00:00
  - event_type: agent_detail
    data:
      messages:
      - role: system
        content: |-
          You are a voice assistant for Home Assistant.
          Answer questions about the world truthfully.
          Answer in plain text. Keep it simple and to the point.
          Current time is 09:31:14. Today's date is 2026-01-27.
        created: 2026-01-27 17:31:14.262406+00:00
      - role: user
        content: |
          # Humidity Fan

          ## Problem statement

          Create a blueprint automation to turn on the fan based on the value of the humidity sensor.

          ## Example use cases

          These are example use cases that could be used with the blueprint:

          - Turn on the bathroom exhaust fan when the bathroom humidty is above 60%
          - Make sure the garage does not get too humid

          ## Detailed Description

          The blueprint should accept two inputs:

          | Input               | Description                                                           |
          | ------------------- | --------------------------------------------------------------------- |
          | `humidity_sensor` | A `sensor` entity that is a humidty sensor that triggers the automation. |
          | `humidity_level` | A `number` selector to set the value used as the trigger. |
          | `fan_entity`     | A `fan` entity to turn on when the automation fires. |

          The automation should trigger when the `humidity_sensor` level goes above `humidity_level`. When
          triggered, the fan should be turned off. The fan should also be stopped when the
          sensor goes back down below the desired level. The automation should not try to
          turn the fan on if it is already on, and should not turn the fan off when it is
          already off.
        attachments: null
        created: 2026-01-27 17:31:14.261336+00:00
      - role: assistant
        agent_id: conversation.mock_title
        content: |-
          ```yaml
          blueprints:
            automation:
              name: Humidity Fan
              variables:
                humidity_sensor: !input 'humidity_sensor'
                humidity_level: !input 'humidity_level'
                fan_entity: !input 'fan_entity'
              trigger:
                - platform: numeric_state
                  entity_id: !input 'humidity_sensor'
                  above: !input 'humidity_level'
                  id: 'humidity_high'
                - platform: numeric_state
                  entity_id: !input 'humidity_sensor'
                  below: !input 'humidity_level'
                  id: 'humidity_low'
              condition:
                - condition: template
                  value_template: >
                    {% if trigger.id == 'humidity_high' and is_state(fan_entity, 'off') or
                       trigger.id == 'humidity_low' and is_state(fan_entity, 'on') %}
                      true
                    {% else %}
                      false
                    {% endif %}
              action:
                - service: >
                    {% if trigger.id == 'humidity_high' %} fan.turn_on
                    {% else %} fan.turn_off
                    {% endif %}
                  target:
                    entity_id: !input 'fan_entity'
              mode: single
          ```
        thinking_content: |-
          1.  **Analyze the Request:**
              *   **Goal:** Create a Home Assistant blueprint automation.
              *   **Trigger:** `humidity_sensor` state changes above `humidity_level`.
              *   **Action (When High):** Turn `fan_entity` *on*.
              *   **Action (When Low):** Turn `fan_entity` *off*.
              *   **Constraints:**
                  *   Use `humidity_level` as a user-defined threshold.
                  *   Use `humidity_sensor` (sensor) and `fan_entity` (fan).
                  *   Don't turn fan on if it's already on (implied condition/automation structure).
                  *   Don't turn fan off if it's already off (implied condition/automation structure).
              *   **Output Format:** Plain text, simple, to the point.
              *   **Context:** Current time 09:31:14, Date 2026-01-27 (irrelevant for the code generation).

          2.  **Determine the Blueprint Structure:**
              *   **Type:** Automation Blueprint.
              *   **Input Variables:** Need `name`, `humidity_sensor`, `humidity_level`, `fan_entity`.
              *   **Trigger:** State change of `humidity_sensor`. Condition: `> humidity_level`.
              *   **Actions:**
                  *   `service: fan.turn_on` for the `fan_entity`.
                  *   `service: fan.turn_off` for the `fan_entity`.

          3.  **Drafting the YAML (Mental or Scratchpad):**

              ```yaml
              blueprints:
                automation:
                  name: Humidity Fan
                  variables:
                    humidity_sensor: !input 'humidity_sensor'
                    humidity_level: !input 'humidity_level'
                    fan_entity: !input 'fan_entity'
                  trigger:
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      above: !input 'humidity_level'
                  action:
                    - service: fan.turn_on
                      entity_id: !input 'fan_entity'
                    - service: fan.turn_off
                      entity_id: !input 'fan_entity'
                  mode: single
              ```

          4.  **Refining the Action Logic (Addressing constraints):**
              The prompt says: "The automation should not try to turn the fan on if it is already on, and should not turn the fan off when it is already off."
              *   *Interpretation:* Standard `turn_on` and `turn_off` services usually handle this safely (Hass ignores requests to turn on if on, turn off if off). However, strictly speaking, relying on the service behavior is the standard way to handle this in Home Assistant without complex conditions in the action block. The prompt might be asking to explicitly *avoid* unnecessary logic, implying just calling the service is fine.
              *   *Alternative Interpretation:* Maybe the user wants a single trigger that does both? No, usually humidty is one direction.
              *   *Scenario:*
                  *   High Humidity -> Turn ON.
                  *   Low Humidity -> Turn OFF.
              *   The prompt implies two distinct states triggering the fan.

          5.  **Finalizing YAML:**

              ```yaml
              blueprints:
                automation:
                  name: Humidity Fan
                  variables:
                    humidity_sensor: !input 'humidity_sensor'
                    humidity_level: !input 'humidity_level'
                    fan_entity: !input 'fan_entity'
                  trigger:
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      above: !input 'humidity_level'
                  condition:
                    - condition: state
                      entity_id: !input 'fan_entity'
                      state: 'off'
                  action:
                    - service: fan.turn_on
                      entity_id: !input 'fan_entity'
                  # Wait, I need to handle the "off" state too.
                  # If I use two separate triggers, I can have one for on and one for off.
              ```

              *Let's try the two-trigger approach for clarity and strict adherence to the prompt's logic flows.*

              *   **Trigger 1 (Turn On):** Sensor > Level AND Fan is OFF.
              *   **Trigger 2 (Turn Off):** Sensor <= Level AND Fan is ON.

              *Refined YAML:*

              ```yaml
              blueprints:
                automation:
                  name: Humidity Fan
                  variables:
                    humidity_sensor: !input 'humidity_sensor'
                    humidity_level: !input 'humidity_level'
                    fan_entity: !input 'fan_entity'
                  trigger:
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      above: !input 'humidity_level'
                      id: 'humidity_high'
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      below: !input 'humidity_level'
                      id: 'humidity_low'
                  condition:
                    - condition: template
                      value_template: >-
                        {{ trigger.id == 'humidity_high' and is_state(fan_entity, 'off') or
                           trigger.id == 'humidity_low' and is_state(fan_entity, 'on') }}
                  action:
                    - service: >
                        {% if trigger.id == 'humidity_high' %} fan.turn_on
                        {% else %} fan.turn_off
                        {% endif %}
                      target:
                        entity_id: !input 'fan_entity'
                  mode: single
              ```

          6.  **Review against constraints:**
              *   *Input `humidity_sensor`*: Included.
              *   *Input `humidity_level`*: Included.
              *   *Input `fan_entity`*: Included.
              *   *Trigger above level*: Included.
              *   *Turn fan on*: Included.
              *   *Trigger below level*: Included.
              *   *Turn fan off*: Included.
              *   *Don't turn on if on*: Handled by the template condition.
              *   *Don't turn off if off*: Handled by the template condition.
              *   *Plain text*: Will provide YAML code block.

          7.  **Simplifying the YAML:**
              Home Assistant's `fan.turn_on` service is idempotent (won't turn on if already on) and `fan.turn_off` is idempotent (won't turn off if already off). Therefore, strict conditionals in the action block are redundant for the "don't try to turn on if on" part. However, for the "don't turn off if off" logic, the service handles it.
              However, the prompt asks to "Create a blueprint automation...".
              The most robust and clean way is using two separate automation flows or a single automation with two triggers.
              Using a single automation with two triggers is often cleaner.

              *Revised Draft (Single Automation, Two Triggers):*

              ```yaml
              blueprints:
                automation:
                  name: Humidity Fan
                  variables:
                    humidity_sensor: !input 'humidity_sensor'
                    humidity_level: !input 'humidity_level'
                    fan_entity: !input 'fan_entity'
                  trigger:
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      above: !input 'humidity_level'
                    - platform: numeric_state
                      entity_id: !input 'humidity_sensor'
                      below: !input 'humidity_level'
                  condition:
                    - condition: template
                      value_template: >-
                        {% if trigger.id == 'humidity_high' and is_state(fan_entity, 'off') or
                           trigger.id == 'humidity_low' and is_state(fan_entity, 'on') %}
                          true
                        {% else %}
                          false
                        {% endif %}
                  action:
                    - service: >
                        {% if trigger.id == 'humidity_high' %} fan.turn_on
                        {% else %} fan.turn_off
                        {% endif %}
                      entity_id: !input 'fan_entity'
                  mode: single
              ```
              This looks correct and adheres to all logic requirements. I will present this.

          8.  **Final Polish:** Ensure variable names match the prompt exactly (`humidity_sensor`, `humidity_level`, `fan_entity`).

              Variable names in prompt: `humidity_sensor`, `humidity_level`, `fan_entity`.

              Trigger logic: `above` for turning on, `below` for turning off.

              Condition logic: Ensure `turn_on` only happens when fan is `off`, and `turn_off` only happens when fan is `on`.

              I will output the code block.
        tool_calls: null
        native: null
        created: 2026-01-27 17:31:34.568099+00:00
      tools: null
    timestamp: 2026-01-27 17:31:14.262413+00:00
  duration_ms: 20306.955
  tries: 1
